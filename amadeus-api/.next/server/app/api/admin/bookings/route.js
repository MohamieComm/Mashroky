"use strict";(()=>{var e={};e.id=602,e.ids=[602],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9971:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>m,patchFetch:()=>f,requestAsyncStorage:()=>c,routeModule:()=>d,serverHooks:()=>g,staticGenerationAsyncStorage:()=>p});var a={};r.r(a),r.d(a,{GET:()=>u,dynamic:()=>l});var s=r(9303),n=r(8716),o=r(3131),i=r(9068);let l="force-dynamic";async function u(e){return(0,i.aL)(e)}let d=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/admin/bookings/route",pathname:"/api/admin/bookings",filename:"route",bundlePath:"app/api/admin/bookings/route"},resolvedPagePath:"C:\\Users\\ishou\\Desktop\\MashroukGit\\Tmahshruk\\CleanMashroky\\amadeus-api\\app\\api\\admin\\bookings\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:c,staticGenerationAsyncStorage:p,serverHooks:g}=d,m="/api/admin/bookings/route";function f(){return(0,o.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:p})}},9068:(e,t,r)=>{r.d(t,{Rf:()=>d,aL:()=>u,c7:()=>c,jj:()=>g,kK:()=>l,kW:()=>p,z2:()=>i});var a=r(7070),s=r(5662),n=r(6149);async function o(e){let t=(0,s.lx)(),r=e.headers.get("authorization");if(!r)throw Error("Unauthorized");let a=r.replace("Bearer ",""),{data:{user:n},error:o}=await t.auth.getUser(a);if(o||!n)throw Error("Unauthorized");let{data:i}=await t.from("profiles").select("role").eq("id",n.id).single();if(!i||!["admin","super_admin"].includes(i.role))throw Error("Forbidden: Admin access required");return{user:n,role:i.role}}async function i(e){try{await o(e);let t=(0,s.lx)(),[r,n,i]=await Promise.all([t.from("bookings").select("id, booking_type, status, total_amount, currency, created_at"),t.from("profiles").select("id, role, created_at"),t.from("api_logs").select("id, endpoint, response_status, response_time_ms, created_at").order("created_at",{ascending:!1}).limit(100)]),l=r.data||[],u=n.data||[],d=i.data||[],c={totalBookings:l.length,bookingsByType:{flight:l.filter(e=>"flight"===e.booking_type).length,hotel:l.filter(e=>"hotel"===e.booking_type).length,transfer:l.filter(e=>"transfer"===e.booking_type).length,activity:l.filter(e=>"activity"===e.booking_type).length},bookingsByStatus:{confirmed:l.filter(e=>"confirmed"===e.status).length,pending:l.filter(e=>"pending"===e.status).length,cancelled:l.filter(e=>"cancelled"===e.status).length,failed:l.filter(e=>"failed"===e.status).length},totalRevenue:l.filter(e=>"confirmed"===e.status).reduce((e,t)=>e+(parseFloat(t.total_amount)||0),0),totalUsers:u.length,adminUsers:u.filter(e=>"admin"===e.role||"super_admin"===e.role).length,apiCalls:d.length,avgResponseTime:d.length>0?Math.round(d.reduce((e,t)=>e+(t.response_time_ms||0),0)/d.length):0,errorRate:d.length>0?Math.round(d.filter(e=>(e.response_status||0)>=400).length/d.length*100):0};return a.NextResponse.json({data:c})}catch(t){let e="Unauthorized"===t.message?401:t.message.includes("Forbidden")?403:500;return a.NextResponse.json({error:t.message},{status:e})}}async function l(e){try{await o(e);let t=(0,s.lx)(),{searchParams:r}=new URL(e.url),n=parseInt(r.get("page")||"1"),i=parseInt(r.get("limit")||"50"),l=(n-1)*i,{data:u,count:d}=await t.from("api_logs").select("*",{count:"exact"}).order("created_at",{ascending:!1}).range(l,l+i-1);return a.NextResponse.json({data:u,meta:{total:d,page:n,limit:i}})}catch(e){return a.NextResponse.json({error:e.message},{status:500})}}async function u(e){try{await o(e);let t=(0,s.lx)(),{searchParams:r}=new URL(e.url),n=parseInt(r.get("page")||"1"),i=parseInt(r.get("limit")||"50"),l=r.get("status"),u=r.get("type"),d=(n-1)*i,c=t.from("bookings").select("*, profiles!inner(full_name, email)",{count:"exact"}).order("created_at",{ascending:!1}).range(d,d+i-1);l&&(c=c.eq("status",l)),u&&(c=c.eq("booking_type",u));let{data:p,count:g}=await c;return a.NextResponse.json({data:p,meta:{total:g,page:n,limit:i}})}catch(e){return a.NextResponse.json({error:e.message},{status:500})}}async function d(e){try{let{role:t}=await o(e),r=(0,s.lx)(),{data:n}=await r.from("profiles").select("*").order("created_at",{ascending:!1});return a.NextResponse.json({data:n})}catch(e){return a.NextResponse.json({error:e.message},{status:500})}}async function c(e){try{let{role:t}=await o(e);if("super_admin"!==t)return a.NextResponse.json({error:"Only super admins can change roles"},{status:403});let{userId:r,newRole:n}=await e.json(),i=(0,s.lx)(),{data:l,error:u}=await i.from("profiles").update({role:n}).eq("id",r).select().single();if(u)throw u;return a.NextResponse.json({data:l})}catch(e){return a.NextResponse.json({error:e.message},{status:500})}}async function p(e){try{let{role:t}=await o(e);if("super_admin"!==t)return a.NextResponse.json({error:"Super admin required"},{status:403});let r=(0,s.lx)(),{data:n}=await r.from("amadeus_config").select("*").single();return a.NextResponse.json({data:n})}catch(e){return a.NextResponse.json({error:e.message},{status:500})}}async function g(e){try{let t;let{role:r}=await o(e);if("super_admin"!==r)return a.NextResponse.json({error:"Super admin required"},{status:403});let i=await e.json(),l=(0,s.lx)(),{data:u}=await l.from("amadeus_config").select("id").single();return t=u?await l.from("amadeus_config").update(i).eq("id",u.id).select().single():await l.from("amadeus_config").insert(i).select().single(),(0,n.e)(),a.NextResponse.json({data:t.data})}catch(e){return a.NextResponse.json({error:e.message},{status:500})}}},5662:(e,t,r)=>{r.d(t,{lx:()=>s});var a=r(7857);function s(){let e=process.env.NEXT_PUBLIC_SUPABASE_URL,t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Missing Supabase server env vars");return(0,a.eI)(e,t,{auth:{autoRefreshToken:!1,persistSession:!1}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[276,972,857,149],()=>r(9971));module.exports=a})();