Auth كامل، API Keys، Docs فاخرة، و SDKs جاهزة.

---

## 1. تصميم نظام Authentication (JWT + Refresh)

### 1.1 نموذج المستخدم وجلسات الريفريش

اعتبر أنك تستخدم MongoDB أو Prisma، هنا سأركز على المنطق:

### `src/types/auth.ts`

```ts
export interface User {
  id: string;
  email: string;
  passwordHash: string;
  apiKey: string;
}

export interface JwtPayload {
  userId: string;
}

export interface RefreshSession {
  id: string;
  userId: string;
  refreshToken: string;
  expiresAt: Date;
}
```

### 1.2 خدمة JWT

### `src/services/jwtService.ts`

```ts
import jwt from "jsonwebtoken";

const ACCESS_TOKEN_TTL = "15m";
const REFRESH_TOKEN_TTL = "30d";

const ACCESS_SECRET = process.env.JWT_ACCESS_SECRET || "access_secret";
const REFRESH_SECRET = process.env.JWT_REFRESH_SECRET || "refresh_secret";

export const signAccessToken = (userId: string): string =>
  jwt.sign({ userId }, ACCESS_SECRET, { expiresIn: ACCESS_TOKEN_TTL });

export const signRefreshToken = (userId: string): string =>
  jwt.sign({ userId }, REFRESH_SECRET, { expiresIn: REFRESH_TOKEN_TTL });

export const verifyAccessToken = (token: string) =>
  jwt.verify(token, ACCESS_SECRET) as { userId: string };

export const verifyRefreshToken = (token: string) =>
  jwt.verify(token, REFRESH_SECRET) as { userId: string };
```

> تخزين الـ refreshToken نفسه (أو hash منه) في DB ضروري لإمكانية إلغائه.

---

## 2. نظام API Keys لكل مستخدم SaaS

### 2.1 توليد API Key

### `src/services/apiKeyService.ts`

```ts
import crypto from "crypto";

export const generateApiKey = (): string =>
  crypto.randomBytes(32).toString("hex");
```

عند إنشاء المستخدم:

```ts
import { generateApiKey } from "./apiKeyService.js";

const apiKey = generateApiKey();
// خزّنه في حقل user.apiKey
```

### 2.2 Middleware للتحقق من API Key

### `src/middleware/apiKeyAuth.ts`

```ts
import { Request, Response, NextFunction } from "express";
// استبدل هذا بالوصول الحقيقي للـ DB
import { findUserByApiKey } from "../repositories/userRepo.js";

export const apiKeyAuth = async (
  req: Request,
  res: Response,
  next: NextFunction
) => {
  const apiKey = req.header("X-API-Key");

  if (!apiKey) {
    return res.status(401).json({ message: "API Key مفقود" });
  }

  const user = await findUserByApiKey(apiKey);
  if (!user) {
    return res.status(401).json({ message: "API Key غير صالح" });
  }

  (req as any).user = user;
  next();
};
```

ثم تضيفه على الراوتات الحساسة:

```ts
app.use("/api/travel", apiKeyAuth, travelRoutes);
```

---

## 3. دمج JWT Auth Endpoints

### `src/routes/authRoutes.ts`

```ts
import { Router, Request, Response } from "express";
import bcrypt from "bcryptjs";
import { signAccessToken, signRefreshToken, verifyRefreshToken } from "../services/jwtService.js";
// استبدل هذه بدوال حقيقية للـ DB
import { findUserByEmail, createUser, saveRefreshSession, findSessionByToken, deleteSession } from "../repositories/authRepo.js";

const router = Router();

router.post("/register", async (req: Request, res: Response) => {
  const { email, password } = req.body;
  const existing = await findUserByEmail(email);
  if (existing) return res.status(400).json({ message: "المستخدم موجود" });

  const passwordHash = await bcrypt.hash(password, 10);
  const user = await createUser({ email, passwordHash });

  res.status(201).json({ message: "تم إنشاء المستخدم", userId: user.id });
});

router.post("/login", async (req: Request, res: Response) => {
  const { email, password } = req.body;
  const user = await findUserByEmail(email);
  if (!user) return res.status(401).json({ message: "بيانات الدخول غير صحيحة" });

  const ok = await bcrypt.compare(password, user.passwordHash);
  if (!ok) return res.status(401).json({ message: "بيانات الدخول غير صحيحة" });

  const accessToken = signAccessToken(user.id);
  const refreshToken = signRefreshToken(user.id);
  await saveRefreshSession(user.id, refreshToken);

  res.json({ accessToken, refreshToken, apiKey: user.apiKey });
});

router.post("/refresh", async (req: Request, res: Response) => {
  const { refreshToken } = req.body;
  if (!refreshToken) return res.status(400).json({ message: "refreshToken مفقود" });

  const session = await findSessionByToken(refreshToken);
  if (!session) return res.status(401).json({ message: "جلسة غير صالحة" });

  const payload = verifyRefreshToken(refreshToken);
  const accessToken = signAccessToken(payload.userId);

  res.json({ accessToken });
});

router.post("/logout", async (req: Request, res: Response) => {
  const { refreshToken } = req.body;
  if (refreshToken) await deleteSession(refreshToken);
  res.json({ message: "تم تسجيل الخروج" });
});

export default router;
```

---

## 4. صفحة وثائق HTML فاخرة بأسلوب mohamie (أسود + ذهبي)

### `public/docs-mohamie.html`

```html
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>وثائق منصة السفر - mohamie</title>
  <style>
    body { margin:0; font-family: system-ui, sans-serif; background:#050509; color:#f5f5f5; }
    header { padding:24px 40px; background:linear-gradient(90deg,#000,#111); border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center; }
    .brand { font-size:24px; font-weight:600; color:#f5f5f5; }
    .brand span { color:#d4af37; }
    .tagline { color:#aaa; font-size:13px; }
    main { padding:32px 40px; max-width:1100px; margin:auto; }
    h1 { font-size:28px; margin-bottom:8px; }
    h2 { margin-top:32px; font-size:20px; color:#d4af37; }
    .card { background:#0b0b11; border:1px solid #262626; border-radius:14px; padding:20px 22px; margin-top:16px; }
    .endpoint { margin-bottom:16px; }
    .method { display:inline-block; padding:2px 10px; border-radius:999px; font-size:11px; margin-left:8px; }
    .get { background:#0b3b2f; color:#4ade80; }
    .url { font-family:monospace; font-size:13px; color:#e5e5e5; }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; background:#111827; color:#9ca3af; font-size:11px; margin-left:6px; }
    .section-sub { color:#9ca3af; font-size:13px; margin-top:4px; }
  </style>
</head>
<body>
  <header>
    <div>
      <div class="brand">لوحة <span>مشروع السفر</span></div>
      <div class="tagline">الذكاء الاصطناعي، التحليلات، الحجوزات، المدفوعات، والعملاء المحتملين في لوحة واحدة.</div>
    </div>
    <div class="pill">API Docs · v1.1</div>
  </header>

  <main>
    <h1>واجهات برمجة تطبيقات السفر</h1>
    <p class="section-sub">هذه الواجهة تخدم تطبيقات السفر داخل منظومة mohamie، مع دعم JWT + API Keys.</p>

    <h2>المصادقة والأمان</h2>
    <div class="card">
      <div class="endpoint">
        <span class="method get">POST</span>
        <span class="url">/auth/login</span>
      </div>
      <div class="endpoint">
        <span class="method get">POST</span>
        <span class="url">/auth/refresh</span>
      </div>
      <div class="endpoint">
        <span class="method get">POST</span>
        <span class="url">/auth/logout</span>
      </div>
      <p class="section-sub">كل الطلبات إلى /api/* تتطلب X-API-Key و Bearer Token صالح.</p>
    </div>

    <h2>نقاط النهاية الأساسية</h2>
    <div class="card">
      <div class="endpoint">
        <span class="method get get">GET</span>
        <span class="url">/api/travel/search?origin=RUH&destination=DXB&date=2025-02-10</span>
      </div>
      <div class="endpoint">
        <span class="method get get">GET</span>
        <span class="url">/api/flights/search?origin=RUH&destination=DXB&date=2025-02-10</span>
      </div>
      <div class="endpoint">
        <span class="method get get">GET</span>
        <span class="url">/api/places/search?query=Dubai attractions</span>
      </div>
      <div class="endpoint">
        <span class="method get get">GET</span>
        <span class="url">/api/weather/current?lat=25.27&lon=55.29</span>
      </div>
      <div class="endpoint">
        <span class="method get get">GET</span>
        <span class="url">/api/cities/search?namePrefix=Dub&limit=10</span>
      </div>
    </div>
  </main>
</body>
</html>
```

ثم في `server.ts`:

```ts
app.use("/mohamie-docs", express.static("public"));
```

---

## 5. توليد SDK جاهز للـ frontend

### 5.1 TypeScript SDK بسيط

### `sdk/ts/travelClient.ts`

```ts
export interface TravelClientOptions {
  baseUrl: string;
  apiKey: string;
  accessToken?: string;
}

export class TravelClient {
  constructor(private opts: TravelClientOptions) {}

  private headers() {
    return {
      "X-API-Key": this.opts.apiKey,
      ...(this.opts.accessToken && {
        Authorization: `Bearer ${this.opts.accessToken}`
      })
    };
  }

  async unifiedSearch(params: { origin: string; destination: string; date: string }) {
    const url = new URL("/api/travel/search", this.opts.baseUrl);
    Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));
    const res = await fetch(url, { headers: this.headers() });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.json();
  }
}
```

### 5.2 Dart SDK (نموذج مختصر)

```dart
class TravelClient {
  final String baseUrl;
  final String apiKey;
  final String? accessToken;

  TravelClient({required this.baseUrl, required this.apiKey, this.accessToken});

  Map<String, String> _headers() => {
        'X-API-Key': apiKey,
        if (accessToken != null) 'Authorization': 'Bearer $accessToken',
      };

  Future<dynamic> unifiedSearch(String origin, String destination, String date) async {
    final uri = Uri.parse('$baseUrl/api/travel/search')
        .replace(queryParameters: {'origin': origin, 'destination': destination, 'date': date});
    final res = await http.get(uri, headers: _headers());
    if (res.statusCode != 200) throw Exception('HTTP ${res.statusCode}');
    return jsonDecode(res.body);
  }
}
```

### 5.3 Swift SDK (نموذج مختصر)

```swift
struct TravelClient {
    let baseUrl: URL
    let apiKey: String
    let accessToken: String?

    func unifiedSearch(origin: String, destination: String, date: String,
                       completion: @escaping (Result<Data, Error>) -> Void) {
        var components = URLComponents(url: baseUrl.appendingPathComponent("/api/travel/search"), resolvingAgainstBaseURL: false)!
        components.queryItems = [
            URLQueryItem(name: "origin", value: origin),
            URLQueryItem(name: "destination", value: destination),
            URLQueryItem(name: "date", value: date)
        ]
        var request = URLRequest(url: components.url!)
        request.addValue(apiKey, forHTTPHeaderField: "X-API-Key")
        if let token = accessToken {
            request.addValue("Bearer \(token)", forHTTPHeaderField: "Authorization")
        }

        URLSession.shared.dataTask(with: request) { data, _, error in
            if let error = error { completion(.failure(error)); return }
            completion(.success(data ?? Data()))
        }.resume()
    }
}
```

---