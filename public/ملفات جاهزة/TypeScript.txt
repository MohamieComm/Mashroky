TypeScript
---

### 1. هيكل المشروع

```bash
travel-backend-ts/
  package.json
  tsconfig.json
  .env
  src/
    server.ts
    config/
      providersConfig.ts
    types/
      travel.ts
    services/
      amadeusService.ts
      googleMapsService.ts
      openWeatherService.ts
      geoDbService.ts
      unifiedTravelService.ts
    routes/
      travelRoutes.ts
```

---

### 2. `package.json`

```json
{
  "name": "travel-backend-ts",
  "version": "1.0.0",
  "main": "dist/server.js",
  "scripts": {
    "build": "tsc",
    "start": "node dist/server.js",
    "dev": "ts-node-dev --respawn --transpile-only src/server.ts"
  },
  "dependencies": {
    "axios": "^1.7.0",
    "cors": "^2.8.5",
    "dotenv": "^16.4.0",
    "express": "^4.19.0"
  },
  "devDependencies": {
    "@types/cors": "^2.8.17",
    "@types/express": "^4.17.21",
    "@types/node": "^22.0.0",
    "ts-node-dev": "^2.0.0",
    "typescript": "^5.6.0"
  }
}
```

---

### 3. `tsconfig.json`

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "CommonJS",
    "rootDir": "src",
    "outDir": "dist",
    "esModuleInterop": true,
    "strict": true,
    "moduleResolution": "node",
    "resolveJsonModule": true,
    "skipLibCheck": true
  },
  "include": ["src"]
}
```

---

### 4. ملف البيئة `.env`

```env
PORT=4000

AMADEUS_API_KEY=your_amadeus_key
AMADEUS_API_SECRET=your_amadeus_secret

GOOGLE_MAPS_API_KEY=your_google_maps_key
OPENWEATHER_API_KEY=your_openweather_key
GEODB_API_KEY=your_geodb_key
```

---

### 5. إعداد المزودين `src/config/providersConfig.ts`

```ts
import dotenv from "dotenv";
dotenv.config();

export const amadeusConfig = {
  clientId: process.env.AMADEUS_API_KEY || "",
  clientSecret: process.env.AMADEUS_API_SECRET || "",
  baseURL: "https://test.api.amadeus.com"
};

export const googleMapsConfig = {
  apiKey: process.env.GOOGLE_MAPS_API_KEY || "",
  baseURL: "https://maps.googleapis.com/maps/api"
};

export const openWeatherConfig = {
  apiKey: process.env.OPENWEATHER_API_KEY || "",
  baseURL: "https://api.openweathermap.org/data/2.5"
};

export const geoDbConfig = {
  apiKey: process.env.GEODB_API_KEY || "",
  baseURL: "https://wft-geo-db.p.rapidapi.com/v1/geo"
};
```

---

### 6. أنواع موحّدة `src/types/travel.ts`

```ts
export interface UnifiedSearchParams {
  origin: string;
  destination: string;
  date: string;
}

export interface UnifiedSearchResult {
  flights: unknown;
  destinationPlaces: unknown;
  destinationCities: unknown;
  weather: unknown | null;
}
```

---

### 7. خدمة Amadeus `src/services/amadeusService.ts`

```ts
import axios, { AxiosResponse } from "axios";
import qs from "querystring";
import { amadeusConfig } from "../config/providersConfig.js";

let amadeusToken: string | null = null;
let tokenExpiresAt = 0;

const getToken = async (): Promise<string> => {
  const now = Date.now();
  if (amadeusToken && now < tokenExpiresAt) return amadeusToken;

  const res: AxiosResponse<any> = await axios.post(
    `${amadeusConfig.baseURL}/v1/security/oauth2/token`,
    qs.stringify({
      grant_type: "client_credentials",
      client_id: amadeusConfig.clientId,
      client_secret: amadeusConfig.clientSecret
    }),
    { headers: { "Content-Type": "application/x-www-form-urlencoded" } }
  );

  amadeusToken = res.data.access_token;
  tokenExpiresAt = now + res.data.expires_in * 1000 - 60000;
  return amadeusToken;
};

interface SearchFlightsParams {
  origin: string;
  destination: string;
  departureDate: string;
}

export const searchFlights = async (
  params: SearchFlightsParams
): Promise<unknown> => {
  const token = await getToken();

  const res: AxiosResponse<any> = await axios.get(
    `${amadeusConfig.baseURL}/v2/shopping/flight-offers`,
    {
      headers: { Authorization: `Bearer ${token}` },
      params: {
        originLocationCode: params.origin,
        destinationLocationCode: params.destination,
        departureDate: params.departureDate,
        adults: 1,
        currencyCode: "USD",
        max: 10
      }
    }
  );

  return res.data;
};
```

---

### 8. خدمة Google Maps `src/services/googleMapsService.ts`

```ts
import axios, { AxiosInstance, AxiosResponse } from "axios";
import { googleMapsConfig } from "../config/providersConfig.js";

const client: AxiosInstance = axios.create({
  baseURL: googleMapsConfig.baseURL,
  timeout: 8000
});

interface SearchPlacesParams {
  query: string;
  language?: string;
}

export const searchPlaces = async (
  params: SearchPlacesParams
): Promise<unknown> => {
  const res: AxiosResponse<any> = await client.get("/place/textsearch/json", {
    params: {
      query: params.query,
      key: googleMapsConfig.apiKey,
      language: params.language || "en"
    }
  });

  return res.data;
};
```

---

### 9. خدمة OpenWeather `src/services/openWeatherService.ts`

```ts
import axios, { AxiosInstance, AxiosResponse } from "axios";
import { openWeatherConfig } from "../config/providersConfig.js";

const client: AxiosInstance = axios.create({
  baseURL: openWeatherConfig.baseURL,
  timeout: 8000
});

interface GetCityWeatherParams {
  lat: number;
  lon: number;
  units?: "metric" | "imperial";
}

export const getCityWeather = async (
  params: GetCityWeatherParams
): Promise<unknown> => {
  const res: AxiosResponse<any> = await client.get("/weather", {
    params: {
      lat: params.lat,
      lon: params.lon,
      appid: openWeatherConfig.apiKey,
      units: params.units || "metric"
    }
  });

  return res.data;
};
```

---

### 10. خدمة GeoDB `src/services/geoDbService.ts`

```ts
import axios, { AxiosInstance, AxiosResponse } from "axios";
import { geoDbConfig } from "../config/providersConfig.js";

const client: AxiosInstance = axios.create({
  baseURL: geoDbConfig.baseURL,
  timeout: 8000,
  headers: {
    "X-RapidAPI-Key": geoDbConfig.apiKey
  }
});

interface SearchCitiesParams {
  namePrefix: string;
  limit?: number;
}

export const searchCities = async (
  params: SearchCitiesParams
): Promise<any> => {
  const res: AxiosResponse<any> = await client.get("/cities", {
    params: {
      namePrefix: params.namePrefix,
      limit: params.limit || 10
    }
  });

  return res.data;
};
```

---

### 11. الخدمة الموحّدة `src/services/unifiedTravelService.ts`

```ts
import { searchFlights } from "./amadeusService.js";
import { searchPlaces } from "./googleMapsService.js";
import { getCityWeather } from "./openWeatherService.js";
import { searchCities } from "./geoDbService.js";
import {
  UnifiedSearchParams,
  UnifiedSearchResult
} from "../types/travel.js";

export const unifiedSearch = async (
  params: UnifiedSearchParams
): Promise<UnifiedSearchResult> => {
  const { origin, destination, date } = params;

  const [flights, destinationPlaces, destinationCities] = await Promise.all([
    searchFlights({
      origin,
      destination,
      departureDate: date
    }),
    searchPlaces({ query: destination }),
    searchCities({ namePrefix: destination })
  ]);

  let weather: unknown | null = null;

  try {
    const city = destinationCities?.data?.[0];
    if (city && city.latitude && city.longitude) {
      weather = await getCityWeather({
        lat: city.latitude,
        lon: city.longitude
      });
    }
  } catch (e: any) {
    console.warn("Weather fetch failed:", e.message);
  }

  return {
    flights,
    destinationPlaces,
    destinationCities,
    weather
  };
};
```

---

### 12. الراوت `src/routes/travelRoutes.ts`

```ts
import { Router, Request, Response } from "express";
import { unifiedSearch } from "../services/unifiedTravelService.js";

const router = Router();

// GET /api/travel/search?origin=RUH&destination=DXB&date=2025-02-10
router.get("/search", async (req: Request, res: Response) => {
  try {
    const { origin, destination, date } = req.query;

    if (!origin || !destination || !date) {
      return res.status(400).json({
        message: "origin, destination, date مطلوبة"
      });
    }

    const data = await unifiedSearch({
      origin: String(origin),
      destination: String(destination),
      date: String(date)
    });

    res.json(data);
  } catch (err: any) {
    console.error(err);
    res.status(500).json({
      message: "حدث خطأ أثناء جلب بيانات السفر",
      error: err.message
    });
  }
});

export default router;
```

---

### 13. السيرفر `src/server.ts`

```ts
import dotenv from "dotenv";
dotenv.config();

import express, { Request, Response } from "express";
import cors from "cors";
import travelRoutes from "./routes/travelRoutes.js";

const app = express();
const port = process.env.PORT || 4000;

app.use(cors());
app.use(express.json());

app.get("/", (req: Request, res: Response) => {
  res.json({ status: "Travel API Gateway (TS) running" });
});

app.use("/api/travel", travelRoutes);

app.listen(port, () => {
  console.log(`Server listening on http://0.0.0.0:${port}`);
});
```

---

### تشغيل سريع

1. أنشئ المجلد، انسخ الملفات كما هي.
2. شغّل:

```bash
npm install
npm run dev
```

ثم جرّب من المتصفح أو Postman:

```text
GET http://localhost:4000/api/travel/search?origin=RUH&destination=DXB&date=2025-02-10
```